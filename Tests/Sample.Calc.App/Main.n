using Nemerle.Collections;
using Nemerle.Imperative;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.Collections.Generic;
using System.Console;
using System.Linq;

using N2;

module Program
{
  Main () : void
  {
    Write("input>");
    def text = ReadLine();

    when (string.IsNullOrEmpty(text))
      return;

    def source = SourceSnapshot(text);
    def parserHost = ParserHost();
    def binaryAst = parserHost.DoParsing(source, _startRule);
    if (binaryAst[0] >= 0)
    {
      def ast = parserHost.CreateAst.[CalcGrammar.Start.Ast](source, _startRule, binaryAst);
      WriteLine("Result: " + ast.Value());
      WriteLine($"Pretty print: $ast");
      WriteLine("AST dump:");
      WriteLine(ast.GetDump().ToString());
      WriteLine();
    }
    else
      WriteLine("Parse error"); //TODO: ouput errors

    Main();
  }

  _startRule : SimpleRuleDescriptor = match (CalcGrammar.GrammarImpl.StaticDescriptor.Rules.Find(rd => rd.Name == "start"))
  {
    | Some(rd is SimpleRuleDescriptor) => rd
    | _ => assert(false)
  };
}

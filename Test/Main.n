using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;
using Nemerle.Parser;

using System;
using System.Collections.Generic;
using SCG = System.Collections.Generic;
using System.Console;
using System.Linq;

variant Ast
{
  | Num    { n : string; }
  | Rounds { ast : Ast; }
  | Op     { l : Ast; name : string; r : Ast; }
}

[ParserGrammar(Options = EmitDebugSources,
  start,
  grammar
  {
    any = ['\u0000'..'\uFFFF'];
    s : void = ' '*;

    start : Ast = s expr !any;

    expr : Ast;

    rounds is expr = '('s expr ')'s;

    d = ['0'..'9'];
    num is expr = d+ s;

    add is expr = expr : 10 '+'s expr : 10;
    sub is expr = expr : 10 '-'s expr : 10;

    mul is expr = expr : 20 '*'s expr : 20;
    div is expr = expr : 20 '/'s expr : 20;
    mod is expr = expr : 20 '%'s expr : 20;

    pow is expr = expr : 31 '^'s expr : 30;
  }
)]
class CalcParser
{
  rounds(_ : NToken, f : Ast, _ : NToken) : Ast { Ast.Rounds(f) }

  num(n : NToken) : Ast { Ast.Num(GetText(n)) }

  add(l : Ast, op : NToken, r : Ast) : Ast { Ast.Op(l, GetText(op), r) }
  sub(l : Ast, op : NToken, r : Ast) : Ast { Ast.Op(l, GetText(op), r) }
  mul(l : Ast, op : NToken, r : Ast) : Ast { Ast.Op(l, GetText(op), r) }
  div(l : Ast, op : NToken, r : Ast) : Ast { Ast.Op(l, GetText(op), r) }
  mod(l : Ast, op : NToken, r : Ast) : Ast { Ast.Op(l, GetText(op), r) }
  pow(l : Ast, op : NToken, r : Ast) : Ast { Ast.Op(l, GetText(op), r) }
}

module Program
{
  Main() : void
  {
    def print(text)
    {
      match (CalcParser().Parse(text))
      {
        | None      => WriteLine($"Can't parse: $text");
        | Some(ast) =>
          def printAst(ast, indent)
          {
            match (ast : Ast)
            {
              | Rounds(ast) =>
                WriteLine($"$indent(");
                printAst(ast, indent + "  ");
                WriteLine($"$indent)");

              | Num(num) =>
                WriteLine($"$indent$num");

              | Op(l, op, r) =>
                WriteLine($"$indent$op");
                printAst(l, indent + "  ");
                printAst(r, indent + "  ");
            }
          }
          WriteLine($"Ast of \"$text\" is:");
          printAst(ast, "")
      }
      WriteLine();
    }
    print("1+2+3");
    print("1+2*3");
    print("1*2-3");
    print("1^2^3");
    print("1*2^3");
    print("1^2*3");
  }
}
using Nitra.Model;
using Nitra.ProjectSystem;

using Nemerle;
using Nemerle.Collections;
using Nemerle.Compiler;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.Collections.Generic;

namespace Nitra.Typing
{
  public partial module TypingUtils
  {
    public SetIdentifierSyntaxMapping(project : NitraProject) : void
    {
      when (project.RootNamespace.Node.BindMany.[AstSymbol](["Nitra", "Runtime", "Binding", "Reference"]) is [referenceSymbol])
      {
        foreach (symbol when symbol.AssemblyId == AssemblyIds.CurrentAssembly && symbol.Options.IsIdentifier in project.RootNamespace.Node.GetDescendants.[SyntaxRuleSymbol]())
        {
          when (symbol is SimpleRuleSymbol(SyntaxMappings = []))
          {
            def loc           = symbol.FirstLocation;
            def returnType    = AstType.Ast(loc, referenceSymbol);
            def expr          = SyntaxMappingExpr.Code(loc, Util.locate(loc.NLocation(), <[ Nitra.Runtime.Binding.Reference(this) ]>));
            def mappingSymbol = ChemicalSyntaxMappingSymbol(symbol, [], returnType, expr);
            symbol.AddSyntaxMapping(mappingSymbol);
          }
        }
      }
    }
  }
}

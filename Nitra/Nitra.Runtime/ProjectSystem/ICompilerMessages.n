using Nemerle;
using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using Nitra.Declarations;

using System;

namespace Nitra
{
  public interface ICompilerMessages
  {
    ReportMessage    (messageType : CompilerMessageType, loc : Location, msg : string, num : int) : void;
    ReportRootMessage(messageType : CompilerMessageType, loc : Location, msg : string, num : int) : IRootCompilerMessages;
  }

  public module ICompilerMessagesExtensions
  {
    public FatalError[T](this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : T                     { messages.ReportMessage    (CompilerMessageType.FatalError, loc.Location,      msg, num); assert(false, msg) }
    public FatalError[T](this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : T                     { messages.ReportMessage    (CompilerMessageType.FatalError, loc,               msg, num); assert(false, msg) }
    public FatalError[T](this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : T                     { messages.ReportMessage    (CompilerMessageType.FatalError, MakeLocation(ast), msg, num); assert(false, msg) }

    public Error        (this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Error,      loc.Location,      msg, num) }
    public Error        (this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Error,      loc,               msg, num) }
    public Error        (this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Error,      MakeLocation(ast), msg, num) }
    public RootError    (this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Error,      loc.Location,      msg, num) }
    public RootError    (this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Error,      loc,               msg, num) }
    public RootError    (this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Error,      MakeLocation(ast), msg, num) }

    public Warning      (this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Warning,    loc.Location,      msg, num) }
    public Warning      (this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Warning,    loc,               msg, num) }
    public Warning      (this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Warning,    MakeLocation(ast), msg, num) }
    public RootWarning  (this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Warning,    loc.Location,      msg, num) }
    public RootWarning  (this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Warning,    loc,               msg, num) }
    public RootWarning  (this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Warning,    MakeLocation(ast), msg, num) }

    public Hint         (this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Hint,       loc.Location,      msg, num) }
    public Hint         (this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Hint,       loc,               msg, num) }
    public Hint         (this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : void                  { messages.ReportMessage    (CompilerMessageType.Hint,       MakeLocation(ast), msg, num) }
    public RootHint     (this messages : ICompilerMessages, loc : Located,  msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Hint,       loc.Location,      msg, num) }
    public RootHint     (this messages : ICompilerMessages, loc : Location, msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Hint,       loc,               msg, num) }
    public RootHint     (this messages : ICompilerMessages, ast : IAst,     msg : string, num : int = -1) : IRootCompilerMessages { messages.ReportRootMessage(CompilerMessageType.Hint,       MakeLocation(ast), msg, num) }

    private MakeLocation(ast : IAst) : Location
    {
      def sourceFile = ast.File;
      assert(sourceFile != null);
      def sourceSnapshot = sourceFile.GetSource();
      def span           = ast.Span; // may be span from some old version of SourceSnapshot
      Location(sourceSnapshot, span)
    }
  }
}

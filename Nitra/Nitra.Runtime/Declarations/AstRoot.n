using Nitra.ProjectSystem;
using Nitra.Runtime.Binding;
using Nitra.Internal;

using Nemerle;
using Nemerle.Assertions;
using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.Collections.Generic;
using System.Linq;

namespace Nitra.Declarations
{
  public sealed class AstRoot[TContent] : IAst
    where TContent : IAst
  {
    public File        : File             { get { Content.File } }
    public Span        : NSpan            { get { Content.Span } }
    public IsAmbiguous : bool             { get false }
    public IsMissing   : bool             { get false }
    public Content     : TContent         { get; }

    private this(content : TContent)
    {
      this.Content = content;
    }

    EvalProperties(context : DependentPropertyEvalContext) : void implements IDependentPropertyHost.EvalProperties
    {
      IgnoreParams();
      throw NotImplementedException();
    }

    public EvalProperties(compilerMessages : ICompilerMessages) : void
    {
      IgnoreParams();
      throw NotImplementedException();
    }

    public EvalProperties([NotNull] context : DependentPropertyEvalContext, [NotNull] compilerMessages : ICompilerMessages) : void
    {
      IgnoreParams();
      throw NotImplementedException();
    }

    public IsPropertyEvaluated(index : int) : bool
    {
      IgnoreParams();
      throw NotImplementedException();
    }

    public IsAllPropertiesEvaluated : bool
    {
      get { Content.IsAllPropertiesEvaluated }
    }

    public ResetProperties() : void
    {
      Content.ResetProperties()
    }

    public static Create(parseTree : IMappedParseTree) : AstRoot[TContent]
    {
      Create(parseTree, DebugCompilerMessages())
    }

    public static Create([NotNull] parseTree : IMappedParseTree, [NotNull] compilerMessages : ICompilerMessages) : AstRoot[TContent]
    {
      mutable oldState;
      try
      {
        oldState = AstContext.Set(compilerMessages);

        def content = parseTree.GetAst() :> TContent;
        AstRoot(content)
      }
      finally AstContext.Restore(oldState)
    }

    public ToXaml() : string { "<Bold>Root</Bold>" }

    public Accept(visitor : IAstVisitor) : void
    {
      this.Content.Accept(visitor)
    }
  }
}
